<html>
<head>
    <script type="text/javascript"
            src="https://dygraphs.com/dygraph.min.js"></script>
    <script type="text/javascript"
            src="/moment.min.js"></script>
    <link rel="stylesheet" href="https://dygraphs.com/dygraph.min.css" />
</head>
<body>
<div id="list"></div>
<div id="graphdiv2"
     style="width:1800px; height:1000px;"></div>
<script type="text/javascript">
    function nameAnnotation(ann) {
        return "(" + ann.series + ", " + ann.x + ")";
    }
    var dateIndex   = [];
    g = new Dygraph(
        document.getElementById("graphdiv2"),
        "/s.csv", // path to CSV file
        {
            delimiter: '|',
            visibility: [true,true,true,true,true,false,false,true,false],
            xValueParser: function(x) {
                dateIndex.push(new Date(x));
                return dateIndex.length - 1;
            },
            ticker: Dygraph.numericTicks,
            axes: {
                x: {
                    valueFormatter: function (val, opts, series_name, dygraph) {
                        // val is the date, which we have rewritten to the array's index.
                        // So here we can exchange it back for the actual date, and format it
                        if (!dateIndex[val]) {
                            return '';
                        }
                        return moment(dateIndex[val]).format("dddd, MMM Do YYYY, HH:mm");
                    },
                    axisLabelFormatter: function (val, granularity, opts, dygraph) {
                        if (!dateIndex[val]) {
                            return '';
                        }
                        return moment(dateIndex[val]).format("MMM DD HH:mm");
                    }
                }
            },
            series: {
                strokeWidth: 2,
                drawPoints: true,
                pointSize: 1.5,
                'smaSlowest': {
                    strokeWidth: 5.0,
                    pointSize: 2,
                    highlightCircleSize: 16,
                    color: 'orange',
                },
                'smaSlow': {
                    strokeWidth: 5.0,
                    color: 'purple',
                },
                'smaFast': {
                    strokeWidth: 5.0,
                    color: 'yellow',
                },
                'emaFast': {
                    strokeWidth: 3.0,
                    color: 'olive',
                },
                'ema2': {
                    strokeWidth: 3.0,
                    color: 'black',
                },
                'bye': {
                    connectSeparatedPoints: true,
                    drawPoints: true,
                    strokeWidth: 3,
                    pointSize: 8,
                    highlightCircleSize: 10
                },
                'sell': {
                    connectSeparatedPoints: true,
                    drawPoints: true,
                    strokeWidth: 3,
                    pointSize: 8,
                    highlightCircleSize: 20
                },
                'position': {
                    connectSeparatedPoints: true,
                    showRoller: true
                },
            },
            drawCallback: function(g) {
                var ann = g.annotations();
                var html = "";
                for (var i = 0; i < ann.length; i++) {
                    var name = nameAnnotation(ann[i]);
                    html += "<span id='" + name + "'>";
                    html += name + ": " + (ann[i].shortText || '(icon)');
                    html += " -> " + ann[i].text + "</span><br/>";
                }
                document.getElementById("list").innerHTML = html;
            },
            plotter2: function candlestickPlotter(e) {
                if (e.seriesIndex > 3) {
                    Dygraph.Plotters.linePlotter(e);
                    return;
                }
                // This is the officially endorsed way to plot all the series at once.
                if (e.seriesIndex !== 0) return;

                var getPrices = function(sets) {
                    var prices = [];
                    var price;
                    for (var p = 0 ; p < sets[0].length; p++) {
                        price = {
                            open : sets[0][p].yval,
                            high : sets[1][p].yval,
                            low : sets[2][p].yval,
                            close : sets[3][p].yval,
                            openY : sets[0][p].y,
                            highY : sets[1][p].y,
                            lowY : sets[2][p].y,
                            closeY : sets[3][p].y
                        };
                        prices.push(price);
                    }
                    return prices;
                };

                var sets = e.allSeriesPoints.slice(0, 4); // Slice first four sets for candlestick chart
                var prices = getPrices(sets);
                var area = e.plotArea;
                var ctx = e.drawingContext;
                ctx.strokeStyle = '#202020';
                ctx.lineWidth = 0.6;

                var minBarWidth = 2;
                var numBars = prices.length + 1; // To compensate the probably removed first "incomplete" bar
                var barWidth = Math.round((area.w / numBars) / 2);
                if (barWidth % 2 !== 0) {
                    barWidth++;
                }
                barWidth = Math.max(barWidth, minBarWidth);

                var price;
                for (var p = 0 ; p < prices.length; p++) {
                    ctx.beginPath();

                    price = prices[p];
                    var topY = area.h * price.highY + area.y;
                    var bottomY = area.h * price.lowY + area.y;
                    var centerX = Math.floor(area.x + sets[0][p].x * area.w) + 0.5; // crisper rendering
                    ctx.moveTo(centerX, topY);
                    ctx.lineTo(centerX, bottomY);
                    ctx.closePath();
                    ctx.stroke();
                    var bodyY;
                    if (price.open > price.close) {
                        ctx.fillStyle ='#d9534f';
                        bodyY = area.h * price.openY + area.y;
                    }
                    else {
                        ctx.fillStyle ='#5cb85c';
                        bodyY = area.h * price.closeY  + area.y;
                    }
                    var bodyHeight = area.h * Math.abs(price.openY - price.closeY);
                    ctx.fillRect(centerX - barWidth / 2, bodyY, barWidth,  bodyHeight);
                }
            },
        }
    );
    g.ready(function() {
        req = new XMLHttpRequest();
        req.onreadystatechange = function () {
            if (req.readyState == 4) {
                if (req.status === 200 ||  // Normal http
                    req.status === 0) {    // Chrome w/ --allow-file-access-from-files
                    var lines = req.responseText.split("\n");
                    var annotations = [];
                    for (var i = 1; i < lines.length; i++) {
                        var line = lines[i];
                        if (line.length === 0) continue;
                        if (line[0] == '#') continue;
                        var inFields = line.split("|");
                        if (inFields.length < 3) continue;
                        var date = new Date(inFields[0]).getTime();
                        var index;
                        for (var j = 0; j < dateIndex.length; j++) {
                            if (dateIndex[j].getTime() === date) {
                                index = j;
                            }
                        }
                        if (index !== undefined) {
                            annotations.push({
                                series: 'ema2',
                                xval: index,
                                x: inFields[0],
                                shortText: inFields[1],
                                text: inFields[2]
                            });
                        }
                    }
                    g.setAnnotations(annotations);
                }
            }
        };

        req.open("GET", '/a.csv', true);
        req.send(null);
    });
</script>
</body>
</html>